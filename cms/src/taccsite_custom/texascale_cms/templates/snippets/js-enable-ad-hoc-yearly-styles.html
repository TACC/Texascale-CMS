<script id="year-js-toggle-css-per-page" type="module">
// Utility to enable/disable ad-hoc yearly styles based on URL year segment

function getYearFromPath() {
    const m = window.location.pathname.match(/\/(\d{4})\//);
    return m ? Number(m[1]) : null;
}

function collectStyles() {
    const modernStyles = [
        ...(document.querySelectorAll(`
            [data-design]:is(style,link):not([data-design="legacy"])
        `))
    ].filter(el => (/^\d{4}$/.test(el.getAttribute('data-design'))
            && Number(el.getAttribute('data-design')) >= 2025));
    const legacyStyles = [
        ...(document.querySelectorAll('[data-design="legacy"]:is(style,link)'))
    ];
    return { modernStyles, legacyStyles };
}

function inEditMode() {
    return Boolean(window.CMS) || Boolean(document.querySelector('.cms-toolbar')) || Boolean(document.querySelector('#cms-toolbar'));
}

function setMedia(els, media) {
    els.forEach(e => e.setAttribute('media', media));
}
function showMedia(els) { setMedia(els, 'all'); }
function hideMedia(els) { setMedia(els, 'not all'); }

function enableModernForYear(year, modernStyles, legacyStyles) {
    const targetStyles = [
        ...(document.querySelectorAll(`[data-design="${year}"]:is(style,link)`))
    ];
    const targetSet = new Set(targetStyles);
    const otherModernStyles = modernStyles.filter(e => !targetSet.has(e));

    showMedia(targetStyles);
    hideMedia(otherModernStyles);
    hideMedia(legacyStyles);

    if (targetStyles.length)
        console.log(`Enabled modern ad-hoc styles for ${year}`);
    else
        console.log(`No ad-hoc yearly styles found for ${year}`);

    if (otherModernStyles.length)
        console.log(`Disabled modern ad-hoc styles for other years`);

    if (legacyStyles.length)
        console.log(`Disabled legacy ad-hoc styles`);
}
function enableLegacy(modernStyles, legacyStyles, year) {
    showMedia(legacyStyles);
    hideMedia(modernStyles);

    if (legacyStyles.length)
        console.log(`Enabled legacy ad-hoc styles`);
    if (modernStyles.length)
        console.log(`Disabled modern ad-hoc styles`);
}
function disableAll(modernStyles, legacyStyles) {
    hideMedia([...modernStyles, ...legacyStyles]);

    console.log('No year recognized. Ad-hoc yearly styles disabled (if not already)');
}

function applyYearStyles() {
    const year = getYearFromPath();
    const isModern = Boolean(year) && year >= 2025;
    const isLegacy = Boolean(year) && year <= 2024;
    const { modernStyles, legacyStyles } = collectStyles();

    if (isModern) {
        enableModernForYear(year, modernStyles, legacyStyles);
    } else if (isLegacy) {
        enableLegacy(modernStyles, legacyStyles, year);
    } else {
        disableAll(modernStyles, legacyStyles);
    }
}

// To run when script loads
applyYearStyles();

// To re-run on DOM changes (Django CMS dynamic partial refreshes)
const observer = new MutationObserver(() => {
    applyYearStyles();
});
observer.observe(document.body, { childList: true, subtree: true });

// To also watch for toolbar/attribute changes that indicate editor mode toggling
const attrObserver = new MutationObserver(() => applyYearStyles());
attrObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['class', 'data-editing'] });
</script>
